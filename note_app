import os
import csv
import getpass
from datetime import datetime
import shutil

# Constants
USER_DB = "users.csv"
NOTES_DIR = "user_notes"
os.makedirs(NOTES_DIR, exist_ok=True)

# Load users
def load_users():
    if not os.path.exists(USER_DB):
        return {}
    with open(USER_DB, mode='r', newline='') as file:
        reader = csv.reader(file)
        return {rows[0]: rows[1] for rows in reader}

# Save user
def save_user(username, password):
    with open(USER_DB, mode='a', newline='') as file:
        writer = csv.writer(file)
        writer.writerow([username, password])

# Authenticate
def authenticate(username, password):
    users = load_users()
    return users.get(username) == password

# Sign up
def sign_up():
    print("\nğŸ”’ SIGN UP ğŸ”’")
    username = input("Enter username: ")
    password = getpass.getpass("Enter password: ")
    save_user(username, password)
    print("âœ… Account created successfully!")

# Login
def login():
    print("\nğŸ”‘ LOGIN ğŸ”‘")
    username = input("Enter username: ")
    password = getpass.getpass("Enter password: ")
    if authenticate(username, password):
        print("âœ… Login successful!")
        user_dashboard(username)
    else:
        print("âŒ Incorrect username or password.")

# User dashboard
def user_dashboard(username):
    while True:
        print(f"\nğŸ“‹ Welcome {username}! Choose an action:")
        print("1. Create new note file")
        print("2. Write to existing file")
        print("3. Show notes")
        print("4. Upload a file")
        print("5. Exit")
        choice = input("â¡ï¸ Enter your choice: ")

        if choice == "1":
            filename = input("Enter new file name: ") + ".txt"
            path = os.path.join(NOTES_DIR, f"{username}_{filename}")
            open(path, 'w').close()
            print(f"ğŸ“ File '{filename}' created.")

        elif choice == "2":
            filename = input("Enter filename to write in: ") + ".txt"
            path = os.path.join(NOTES_DIR, f"{username}_{filename}")
            if os.path.exists(path):
                note = input("Enter your note: ")
                with open(path, "a") as f:
                    f.write(f"{datetime.now()}: {note}\n")
                print("âœï¸ Note added.")
            else:
                print("âŒ File does not exist.")

        elif choice == "3":
            for file in os.listdir(NOTES_DIR):
                if file.startswith(username):
                    print(f"\nğŸ“„ {file.replace(username + '_', '')}:")
                    with open(os.path.join(NOTES_DIR, file)) as f:
                        print(f.read())

        elif choice == "4":
            filename = input("Enter name to save uploaded file as: ")
            source_path = input("Enter full path of the file to upload: ")
            dest_path = os.path.join(NOTES_DIR, f"{username}_{filename}")
            try:
                shutil.copy(source_path, dest_path)
                print("ğŸ“ File uploaded successfully.")
            except FileNotFoundError:
                print("âŒ Source file not found.")

        elif choice == "5":
            print("ğŸšª Exiting dashboard.")
            break
        else:
            print("âŒ Invalid choice.")

# Show user details (admin access)
def show_user_details():
    print("\nğŸ” ADMIN ACCESS ğŸ”")
    username = input("Enter admin username: ")
    password = getpass.getpass("Enter admin password: ")
    if authenticate(username, password):
        users = load_users()
        print(f"\nğŸ‘¥ Total users: {len(users)}")
        for user in users:
            count = sum(1 for file in os.listdir(NOTES_DIR) if file.startswith(user))
            print(f"{user}: {count} file(s)")
    else:
        print("âŒ Unauthorized access.")

# Main app menu
def main_menu():
    while True:
        print("\nâœ¨ Welcome to CLI NoteApp âœ¨")
        print("1. Login")
        print("2. Sign up")
        print("3. Show user details (admin)")
        print("4. Quit")
        choice = input("â¡ï¸ Choose an option: ")

        if choice == "1":
            login()
        elif choice == "2":
            sign_up()
        elif choice == "3":
            show_user_details()
        elif choice == "4":
            print("ğŸ‘‹ Exiting app. Goodbye!")
            break
        else:
            print("âŒ Invalid input. Try again.")

main_menu()

